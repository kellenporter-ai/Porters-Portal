<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Interactive Force Diagram Creator</title>
    <style>
        :root {
            /* Modern Glass Theme Colors */
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: 1px solid rgba(255, 255, 255, 0.5);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);

            --accent-blue: #007aff;
            --accent-blue-glass: rgba(0, 122, 255, 0.25);
            --accent-green: #34C759;
            --accent-red: #FF3B30;

            --text-dark: #333;

            --diagram-arrow-color: #557A45;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            background: var(--bg-gradient);
            color: var(--text-dark);
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: var(--glass-border);
            box-shadow: var(--glass-shadow);
        }

        /* --- LEFT PANEL: LIST --- */
        #list-panel {
            width: 260px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 2;
            border-right: var(--glass-border);
        }

        .panel-header {
            text-align: center;
            font-size: 22px;
            font-weight: 600;
            padding: 15px;
            color: var(--accent-blue);
            border-bottom: var(--glass-border);
            background: rgba(255,255,255,0.3);
        }

        .list-container {
            padding: 15px 10px;
            flex-grow: 1;
            overflow-y: auto;
        }

        .list-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 16px;
            font-weight: 500;
            color: var(--accent-blue);
        }

        .list-num {
            width: 30px;
            text-align: right;
            margin-right: 10px;
            opacity: 0.7;
        }

        .list-input {
            flex-grow: 1;
            border: 1px solid rgba(0,0,0,0.1);
            padding: 8px;
            border-radius: 8px;
            font-size: 15px;
            color: var(--text-dark);
            background: rgba(255,255,255,0.5);
            transition: all 0.2s;
        }
        .list-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            background: white;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        /* --- MIDDLE PANEL: CANVAS --- */
        #canvas-panel {
            flex-grow: 1;
            position: relative;
            background-color: rgba(255,255,255,0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            z-index: 1;
        }

        #diagram-title {
            position: absolute;
            top: 0;
            background-color: var(--diagram-arrow-color);
            color: white;
            padding: 6px 30px;
            border-radius: 0 0 12px 12px;
            font-weight: 600;
            font-size: 18px;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        canvas { cursor: crosshair; touch-action: none; }

        .axis-label {
            position: absolute;
            color: #999;
            font-family: monospace;
            font-weight: bold;
            pointer-events: none;
        }

        /* --- ARROW LABELS --- */
        .force-label-container {
            position: absolute;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
            padding: 4px 8px;
            border-radius: 6px;
            font-family: Arial, sans-serif;
            font-weight: bold;
            font-size: 16px;
            color: var(--diagram-arrow-color);
            pointer-events: auto;
            white-space: nowrap;
            z-index: 5;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid rgba(0,0,0,0.05);
            transition: transform 0.1s, top 0.1s, left 0.1s;
        }

        .force-label-input {
            width: 35px;
            border: none;
            border-bottom-width: 2px;
            border-bottom-style: solid;
            text-align: center;
            font-weight: bold;
            font-size: 15px;
            background: transparent;
            outline: none;
            padding: 2px 0;
            margin: 0 2px;
        }

        .input-blue { color: var(--accent-blue); border-bottom-color: var(--accent-blue); }
        .input-red { color: var(--accent-red); border-bottom-color: var(--accent-red); }
        .force-sub-text { font-size: 13px; color: #666; font-weight: normal;}

        .delete-btn {
            position: absolute;
            top: -6px; right: -6px;
            width: 18px; height: 18px;
            background-color: var(--accent-red);
            color: white;
            border: none; border-radius: 50%;
            font-size: 14px; line-height: 16px;
            text-align: center; cursor: pointer;
            display: none; z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .force-label-container:hover .delete-btn { display: block; }

        #tooltip {
            position: absolute;
            background: var(--glass-bg);
            backdrop-filter: blur(8px);
            border: 1px solid var(--accent-blue);
            padding: 6px 12px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            pointer-events: none;
            display: none;
            z-index: 20;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .controls-container {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            z-index: 30;
        }

        .control-btn {
            width: 32px; height: 32px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: var(--glass-border);
            border-radius: 50%;
            color: var(--accent-blue);
            font-weight: bold; font-size: 18px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            box-shadow: var(--glass-shadow);
            transition: all 0.2s;
            text-decoration: none;
        }
        .control-btn:hover { background: white; transform: scale(1.05); }

        /* Floating Precision Editor */
        #precision-editor {
            position: absolute;
            display: none;
            background: var(--accent-blue-glass);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 122, 255, 0.3);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 122, 255, 0.15);
            width: 190px;
            color: var(--text-dark);
            z-index: 100;
        }

        .editor-title {
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-blue);
            text-align: center;
        }

        .editor-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 500;
        }

        .editor-row.checkbox-row {
            justify-content: flex-end;
            gap: 8px;
        }

        .editor-input {
            width: 70px;
            border: 1px solid rgba(0,0,0,0.1);
            background: rgba(255,255,255,0.7);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 13px;
            text-align: right;
        }
        .editor-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            background: white;
        }

        .close-editor {
            position: absolute; top: 5px; right: 8px;
            cursor: pointer; color: var(--accent-blue); font-size: 18px;
        }

        /* --- HELP MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4);
            display: none;
            justify-content: center; align-items: center;
            z-index: 100;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            width: 480px;
            max-width: 90vw;
            padding: 30px;
            border-radius: 16px;
            position: relative;
        }

        .modal-close {
            position: absolute; top: 15px; right: 20px;
            font-size: 28px; cursor: pointer; color: #999;
            transition: color 0.2s;
        }
        .modal-close:hover { color: var(--text-dark); }

        .modal-title {
            margin-top: 0;
            color: var(--accent-blue);
            font-size: 22px; font-weight: 700;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            padding-bottom: 15px; margin-bottom: 20px;
        }

        .help-list { list-style: none; padding: 0; margin: 0; }
        .help-list li {
            margin-bottom: 16px; display: flex; align-items: flex-start;
            font-size: 15px; color: var(--text-dark);
        }
        .help-icon { margin-right: 15px; font-size: 20px; width: 24px; text-align: center; }
        .key-badge {
            background: #eee; border: 1px solid #ccc;
            border-radius: 5px; padding: 2px 6px;
            font-family: monospace; font-size: 13px; font-weight: bold;
            box-shadow: 0 2px 0 #ccc;
        }

        /* --- MOBILE RESPONSIVE --- */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            #list-panel {
                width: 100%;
                height: 35%;
                order: 2;
                border-right: none;
                border-top: var(--glass-border);
            }
            #canvas-panel {
                height: 65%;
                order: 1;
            }
            .list-container {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            .controls-container {
                top: auto;
                bottom: 10px;
                right: 10px;
                flex-wrap: wrap;
                justify-content: flex-end;
            }
            .delete-btn { display: block; width: 24px; height: 24px; font-size: 18px; top: -10px; right: -10px; }
            .force-label-container { padding: 6px 10px; font-size: 14px; }
            .control-btn { width: 36px; height: 36px; font-size: 20px; }
        }
    </style>
</head>
<body>

    <div id="list-panel" class="glass-panel">
        <div class="panel-header">LIST</div>
        <div class="list-container" id="list-items">
            </div>
    </div>

    <div id="canvas-panel">
        <div id="diagram-title">Force Diagram</div>

        <div class="controls-container">
            <button class="control-btn" id="reset-btn" title="Reset Diagram & List">üîÑ</button>
            <button class="control-btn" id="save-img-btn" title="Save as Image (PNG)">üì∑</button>
            <button class="control-btn" id="save-json-btn" title="Save Project File">üíæ</button>
            <button class="control-btn" id="load-json-btn" title="Load Project File">üìÇ</button>
            <button class="control-btn" id="help-btn" title="How to use this tool">?</button>
        </div>
        <input type="file" id="file-input" style="display: none;" accept=".json">

        <div id="precision-editor">
            <span class="close-editor" id="close-editor-btn">&times;</span>
            <h4 class="editor-title">Precision Editor</h4>
            <div class="editor-row">
                <label for="edit-length">Length (px):</label>
                <input type="number" id="edit-length" class="editor-input" min="10" step="1">
            </div>
            <div class="editor-row">
                <label for="edit-angle">Angle (&theta;¬∞):</label>
                <input type="number" id="edit-angle" class="editor-input" step="1">
            </div>
            <div class="editor-row checkbox-row">
                <label for="edit-component" style="cursor: pointer;">Component Force</label>
                <input type="checkbox" id="edit-component" style="cursor: pointer;">
            </div>
        </div>

        <div class="axis-label" style="top: 15px; left: 50%; transform: translateX(-50%);">+y</div>
        <div class="axis-label" style="bottom: 15px; left: 50%; transform: translateX(-50%);">-y</div>
        <div class="axis-label" style="right: 15px; top: 50%; transform: translateY(-50%);">+x</div>
        <div class="axis-label" style="left: 15px; top: 50%; transform: translateY(-50%);">-x</div>

        <canvas id="forceCanvas"></canvas>
        <div id="tooltip"></div>
        <div id="labels-layer"></div>
    </div>

    <div id="help-modal" class="modal-overlay">
        <div class="modal-content glass-panel">
            <span class="modal-close">&times;</span>
            <h3 class="modal-title">How to Use</h3>
            <ul class="help-list">
                <li>
                    <span class="help-icon">üîÑ</span>
                    <div><b>Reset:</b> Clear everything and start over.</div>
                </li>
                <li>
                    <span class="help-icon">üì∑</span>
                    <div><b>Save Image:</b> Download a PNG for submission.</div>
                </li>
                <li>
                    <span class="help-icon">üíæ</span>
                    <div><b>Save/Load:</b> Save your work to a file to resume later.</div>
                </li>
                <li>
                    <span class="help-icon">‚úèÔ∏è</span>
                    <div><b>Create Arrow:</b> Click the center black dot and drag outwards.</div>
                </li>
                <li>
                    <span class="help-icon">üìê</span>
                    <div><b>Snap Angles:</b> Hold <span class="key-badge">Shift</span> while dragging.</div>
                </li>
                <li>
                    <span class="help-icon">üéØ</span>
                    <div><b>Precision Mode:</b> Hold <span class="key-badge">Ctrl</span> and click an arrow head.</div>
                </li>
                <li>
                    <span class="help-icon">‚ùå</span>
                    <div><b>Delete:</b> Hover over a label and click the red <b>√ó</b>.</div>
                </li>
            </ul>
        </div>
    </div>

    <script>
        // --- SETUP ---
        const listContainer = document.getElementById('list-items');
        for (let i = 1; i <= 10; i++) {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.innerHTML = `<span class="list-num">${i}.</span><input type="text" class="list-input" placeholder="[type here]">`;
            listContainer.appendChild(div);
        }

        const canvas = document.getElementById('forceCanvas');
        const ctx = canvas.getContext('2d');
        const labelsLayer = document.getElementById('labels-layer');
        const tooltip = document.getElementById('tooltip');
        const container = document.getElementById('canvas-panel');

        // Precision Editor Elements
        const editorPanel = document.getElementById('precision-editor');
        const editLenInput = document.getElementById('edit-length');
        const editAngInput = document.getElementById('edit-angle');
        const editComponentCheckbox = document.getElementById('edit-component');
        const closeEditorBtn = document.getElementById('close-editor-btn');

        // Save/Load Controls
        const resetBtn = document.getElementById('reset-btn');
        const saveImgBtn = document.getElementById('save-img-btn');
        const saveJsonBtn = document.getElementById('save-json-btn');
        const loadJsonBtn = document.getElementById('load-json-btn');
        const fileInput = document.getElementById('file-input');

        let width, height, centerX, centerY;
        let arrows = [];
        let draggingArrow = null;
        let isCreatingNew = false;
        let editingArrowForPrecision = null;

        const centerRadius = 15;
        const arrowHeadLen = 15;
        const arrowColor = "#557A45";
        const highlightColor = "#007aff";

        function resize() {
            const newWidth = container.clientWidth;
            const newHeight = container.clientHeight;

            if (width !== undefined && height !== undefined) {
                const shiftX = (newWidth - width) / 2;
                const shiftY = (newHeight - height) / 2;
                arrows.forEach(a => {
                    a.endX += shiftX;
                    a.endY += shiftY;
                });
            }

            width = newWidth;
            height = newHeight;
            canvas.width = width;
            canvas.height = height;
            centerX = width / 2;
            centerY = height / 2;
            draw();
        }
        window.addEventListener('resize', resize);

        // --- DRAWING ---
        function drawGrid() {
            ctx.clearRect(0, 0, width, height);
            ctx.beginPath();
            ctx.setLineDash([4, 4]);
            ctx.strokeStyle = "#ccc";
            ctx.lineWidth = 1;
            ctx.moveTo(0, centerY); ctx.lineTo(width, centerY);
            ctx.moveTo(centerX, 0); ctx.lineTo(centerX, height);
            ctx.stroke();
            ctx.setLineDash([]);
        }

        function drawCenterObject() {
            ctx.beginPath();
            ctx.arc(centerX, centerY, centerRadius, 0, Math.PI * 2);
            ctx.fillStyle = "black";
            ctx.fill();
        }

        function drawArrow(arrow) {
            const startX = arrow.offsetStartX !== undefined ? arrow.offsetStartX : centerX;
            const startY = arrow.offsetStartY !== undefined ? arrow.offsetStartY : centerY;
            const endX = arrow.offsetEndX !== undefined ? arrow.offsetEndX : arrow.endX;
            const endY = arrow.offsetEndY !== undefined ? arrow.offsetEndY : arrow.endY;

            const dx = endX - startX;
            const dy = endY - startY;
            const angle = Math.atan2(dy, dx);

            const isHighlighted = arrow === editingArrowForPrecision;
            const currentColor = isHighlighted ? highlightColor : arrowColor;

            ctx.beginPath();
            ctx.lineWidth = isHighlighted ? 5 : 4;
            ctx.strokeStyle = currentColor;
            ctx.fillStyle = currentColor;

            if (arrow.isComponent) {
                ctx.setLineDash([6, 4]);
            }

            ctx.moveTo(startX, startY);
            ctx.lineTo(endX, endY);
            ctx.stroke();

            ctx.setLineDash([]);

            ctx.beginPath();
            ctx.moveTo(endX, endY);
            ctx.lineTo(endX - arrowHeadLen * Math.cos(angle - Math.PI / 6), endY - arrowHeadLen * Math.sin(angle - Math.PI / 6));
            ctx.lineTo(endX - arrowHeadLen * Math.cos(angle + Math.PI / 6), endY - arrowHeadLen * Math.sin(angle + Math.PI / 6));
            ctx.lineTo(endX, endY);
            ctx.fill();

            if (isHighlighted) {
                ctx.shadowColor = highlightColor;
                ctx.shadowBlur = 10;
                ctx.stroke();
                ctx.fill();
                ctx.shadowBlur = 0;
            }
        }

        // --- OVERLAP LOGIC ---
        function calculateArrowOffsets() {
            arrows.forEach(a => {
                a.offsetStartX = centerX;
                a.offsetStartY = centerY;
                a.offsetEndX = a.endX;
                a.offsetEndY = a.endY;
                a.groupIndex = 0;
            });

            const groups = [];
            const visited = new Set();

            for(let i=0; i<arrows.length; i++) {
                if(visited.has(arrows[i].id)) continue;
                const group = [arrows[i]];
                visited.add(arrows[i].id);
                const a1Angle = getPhysicsAngle(arrows[i].endX, arrows[i].endY);

                for(let j=i+1; j<arrows.length; j++) {
                    if(visited.has(arrows[j].id)) continue;
                    const a2Angle = getPhysicsAngle(arrows[j].endX, arrows[j].endY);
                    let diff = Math.abs(a1Angle - a2Angle);
                    if(diff > 180) diff = 360 - diff;

                    if(diff < 3) {
                        group.push(arrows[j]);
                        visited.add(arrows[j].id);
                    }
                }
                groups.push(group);
            }

            const spacing = 12;
            groups.forEach(group => {
                if(group.length <= 1) return;

                const dx = group[0].endX - centerX;
                const dy = group[0].endY - centerY;
                const len = Math.sqrt(dx*dx + dy*dy) || 1;
                const perpX = -(dy/len);
                const perpY = (dx/len);

                group.forEach((arrow, index) => {
                    const centeredIndex = index - (group.length - 1) / 2;
                    arrow.groupIndex = centeredIndex;

                    const shiftX = perpX * centeredIndex * spacing;
                    const shiftY = perpY * centeredIndex * spacing;

                    arrow.offsetStartX += shiftX;
                    arrow.offsetStartY += shiftY;
                    arrow.offsetEndX = arrow.endX + shiftX;
                    arrow.offsetEndY = arrow.endY + shiftY;
                });
            });
        }

        function draw() {
            drawGrid();
            drawCenterObject();
            calculateArrowOffsets();

            arrows.forEach(a => {
                if (a !== draggingArrow) drawArrow(a);
            });

            if (draggingArrow) drawArrow(draggingArrow);

            updateLabelPositions();
        }

        // --- MATH HELPERS ---
        function dist(x1, y1, x2, y2) { return Math.sqrt((x2-x1)**2 + (y2-y1)**2); }
        function getPhysicsAngle(x, y) {
            const dx = x - centerX;
            const dy = -(y - centerY);
            let theta = Math.atan2(dy, dx) * (180 / Math.PI);
            if (theta < 0) theta += 360;
            return Math.round(theta * 10) / 10;
        }
        function getLength(x, y) { return Math.round(dist(centerX, centerY, x, y)); }

        // --- INTERACTION ---
        function createLabelInput(arrowObj) {
            const div = document.createElement('div');
            div.className = 'force-label-container';
            div.innerHTML = `
                <button class="delete-btn" title="Delete Arrow">√ó</button>
                F <input class="force-label-input input-blue" value="${arrowObj.label1 || ''}">
                <span class="force-sub-text">on</span>
                <input class="force-label-input input-red" value="${arrowObj.label2 || ''}">
            `;
            const inputs = div.querySelectorAll('input');
            inputs[0].addEventListener('input', (e) => arrowObj.label1 = e.target.value);
            inputs[1].addEventListener('input', (e) => arrowObj.label2 = e.target.value);
            div.querySelector('.delete-btn').addEventListener('click', () => deleteArrow(arrowObj));
            labelsLayer.appendChild(div);
            arrowObj.inputEl = div;
            updateLabelPositions();
        }

        function deleteArrow(arrowObj) {
            if (arrowObj.inputEl) arrowObj.inputEl.remove();
            if (arrowObj === editingArrowForPrecision) closePrecisionEditor();
            arrows = arrows.filter(a => a !== arrowObj);
            draw();
            tooltip.style.display = 'none';
        }

        function updateLabelPositions() {
            arrows.forEach(a => {
                if(a.inputEl) {
                    const finalX = a.offsetEndX !== undefined ? a.offsetEndX : a.endX;
                    const finalY = a.offsetEndY !== undefined ? a.offsetEndY : a.endY;

                    const angle = getPhysicsAngle(a.endX, a.endY) % 360;
                    const isVertical = (angle > 45 && angle < 135) || (angle > 225 && angle < 315);
                    const idx = a.groupIndex || 0;

                    let left = finalX;
                    let top = finalY;
                    let transform = '';

                    if (isVertical) {
                        const spreadX = idx * 130;
                        left += spreadX;
                        if (finalY >= centerY) {
                            top += 18;
                            transform = 'translate(-50%, 0)';
                        } else {
                            top -= 18;
                            transform = 'translate(-50%, -100%)';
                        }
                    } else {
                        const spreadY = idx * 60;
                        top += spreadY;
                        if (finalY >= centerY) {
                            top += 18;
                            transform = 'translate(-50%, 0)';
                        } else {
                            top -= 18;
                            transform = 'translate(-50%, -100%)';
                        }
                    }

                    a.inputEl.style.left = left + 'px';
                    a.inputEl.style.top = top + 'px';
                    a.inputEl.style.transform = transform;
                }
            });
        }

        function getArrowUnderMouse(mx, my) {
            for (let a of arrows) {
                const finalX = a.offsetEndX !== undefined ? a.offsetEndX : a.endX;
                const finalY = a.offsetEndY !== undefined ? a.offsetEndY : a.endY;
                if (dist(mx, my, finalX, finalY) < 20) return a;
            }
            return null;
        }

        // --- DYNAMIC EDITOR ---
        function openPrecisionEditor(arrow) {
            editingArrowForPrecision = arrow;
            const finalX = arrow.offsetEndX !== undefined ? arrow.offsetEndX : arrow.endX;
            const finalY = arrow.offsetEndY !== undefined ? arrow.offsetEndY : arrow.endY;
            editorPanel.style.left = (finalX + 20) + 'px';
            editorPanel.style.top = (finalY + 20) + 'px';
            editorPanel.style.display = 'block';
            editLenInput.value = getLength(arrow.endX, arrow.endY);
            editAngInput.value = getPhysicsAngle(arrow.endX, arrow.endY);
            editComponentCheckbox.checked = arrow.isComponent || false;
            draw();
        }

        function closePrecisionEditor() {
            editingArrowForPrecision = null;
            editorPanel.style.display = 'none';
            draw();
        }

        function updateArrowFromEditor() {
            if (!editingArrowForPrecision) return;
            const len = parseFloat(editLenInput.value) || 10;
            const physicsAngle = parseFloat(editAngInput.value) || 0;
            const radians = -physicsAngle * (Math.PI / 180);

            editingArrowForPrecision.endX = centerX + len * Math.cos(radians);
            editingArrowForPrecision.endY = centerY + len * Math.sin(radians);
            editingArrowForPrecision.isComponent = editComponentCheckbox.checked;

            draw();
            const finalX = editingArrowForPrecision.offsetEndX !== undefined ? editingArrowForPrecision.offsetEndX : editingArrowForPrecision.endX;
            const finalY = editingArrowForPrecision.offsetEndY !== undefined ? editingArrowForPrecision.offsetEndY : editingArrowForPrecision.endY;
            editorPanel.style.left = (finalX + 20) + 'px';
            editorPanel.style.top = (finalY + 20) + 'px';
        }

        editLenInput.addEventListener('input', updateArrowFromEditor);
        editAngInput.addEventListener('input', updateArrowFromEditor);
        editComponentCheckbox.addEventListener('change', updateArrowFromEditor);
        closeEditorBtn.addEventListener('click', closePrecisionEditor);

        // --- SAVE / LOAD / RESET FUNCTIONS ---

        // RESET
        resetBtn.addEventListener('click', () => {
            if(confirm("Are you sure you want to clear the entire diagram and list?")) {
                // Clear DOM labels
                arrows.forEach(a => { if(a.inputEl) a.inputEl.remove(); });
                arrows = [];
                editingArrowForPrecision = null;
                editorPanel.style.display = 'none';

                // Clear List Inputs
                document.querySelectorAll('.list-input').forEach(input => input.value = '');

                draw();
            }
        });

        // SAVE IMAGE
        saveImgBtn.addEventListener('click', () => {
            ctx.save();
            ctx.globalCompositeOperation = 'destination-over';
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.globalCompositeOperation = 'source-over';

            ctx.fillStyle = "#999";
            ctx.font = "bold 16px monospace";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText("+y", centerX, 15);
            ctx.fillText("-y", centerX, height - 15);
            ctx.fillText("+x", width - 15, centerY);
            ctx.fillText("-x", 15, centerY);

            ctx.font = "bold 16px Arial";
            arrows.forEach(a => {
                const finalX = a.offsetEndX !== undefined ? a.offsetEndX : a.endX;
                const finalY = a.offsetEndY !== undefined ? a.offsetEndY : a.endY;
                const angle = getPhysicsAngle(a.endX, a.endY) % 360;
                const isVertical = (angle > 45 && angle < 135) || (angle > 225 && angle < 315);
                const idx = a.groupIndex || 0;

                let left = finalX;
                let top = finalY;

                if (isVertical) {
                    left += idx * 130;
                    if (finalY >= centerY) top += 18; else top -= 18;
                } else {
                    top += idx * 60;
                    if (finalY >= centerY) top += 18; else top -= 18;
                }

                const l1 = a.label1 || "___";
                const l2 = a.label2 || "___";

                const boxW = 100; const boxH = 26;
                let boxY = top;
                if (finalY < centerY && isVertical) boxY -= boxH;
                if (finalY < centerY && !isVertical) boxY -= boxH;

                ctx.fillStyle = "rgba(255,255,255,0.9)";
                ctx.fillRect(left - boxW/2, boxY, boxW, boxH);

                let tx = left - 35;
                let ty = boxY + 18;

                ctx.fillStyle = "#557A45"; ctx.fillText("F", tx, ty); tx += 12;
                ctx.fillStyle = "#007aff"; ctx.fillText(l1, tx, ty); tx += (ctx.measureText(l1).width + 5);
                ctx.fillStyle = "#000"; ctx.fillText("on", tx, ty); tx += 22;
                ctx.fillStyle = "#FF3B30"; ctx.fillText(l2, tx, ty);
            });

            const link = document.createElement('a');
            link.download = 'force-diagram.png';
            link.href = canvas.toDataURL();
            link.click();
            ctx.restore();
            draw();
        });

        // SAVE JSON
        saveJsonBtn.addEventListener('click', () => {
            const listInputs = Array.from(document.querySelectorAll('.list-input')).map(i => i.value);
            const data = {
                arrows: arrows.map(a => ({
                    id: a.id,
                    endX: a.endX, endY: a.endY,
                    label1: a.label1, label2: a.label2,
                    isComponent: a.isComponent
                })),
                list: listInputs,
                centerX: centerX, centerY: centerY,
                timestamp: Date.now()
            };
            const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'force-diagram-project.json';
            link.click();
        });

        // LOAD JSON
        loadJsonBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                try {
                    const data = JSON.parse(evt.target.result);
                    const listInputs = document.querySelectorAll('.list-input');
                    if (data.list) {
                        data.list.forEach((val, i) => { if(listInputs[i]) listInputs[i].value = val; });
                    }

                    const oldCX = data.centerX || centerX;
                    const oldCY = data.centerY || centerY;
                    const diffX = centerX - oldCX;
                    const diffY = centerY - oldCY;

                    arrows.forEach(a => { if(a.inputEl) a.inputEl.remove(); });
                    arrows = [];

                    if (data.arrows) {
                        data.arrows.forEach(savedArrow => {
                            const newArrow = {
                                id: savedArrow.id || Date.now(),
                                endX: savedArrow.endX + diffX,
                                endY: savedArrow.endY + diffY,
                                label1: savedArrow.label1,
                                label2: savedArrow.label2,
                                isComponent: savedArrow.isComponent || false
                            };
                            arrows.push(newArrow);
                            createLabelInput(newArrow);
                        });
                    }
                    draw();
                } catch(err) {
                    alert("Error loading file: " + err);
                }
            };
            reader.readAsText(file);
            fileInput.value = '';
        });


        // --- MOUSE EVENTS ---
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mx = e.clientX - rect.left;
            const my = e.clientY - rect.top;
            const clickedArrow = getArrowUnderMouse(mx, my);

            if (e.ctrlKey && clickedArrow) {
                openPrecisionEditor(clickedArrow);
                return;
            }

            if (clickedArrow) {
                draggingArrow = clickedArrow;
                isCreatingNew = false;
                closePrecisionEditor();
                return;
            }

            if (dist(mx, my, centerX, centerY) < centerRadius + 5) {
                isCreatingNew = true;
                closePrecisionEditor();
                draggingArrow = { id: Date.now(), endX: mx, endY: my, label1: '', label2: '', isComponent: false };
                arrows.push(draggingArrow);
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mx = e.clientX - rect.left;
            const my = e.clientY - rect.top;

            if (draggingArrow) {
                let currentMX = mx, currentMY = my;
                if (e.shiftKey) {
                    const dx = mx - centerX, dy = my - centerY;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    let angle = Math.atan2(dy, dx);
                    const snap = Math.PI / 4;
                    angle = Math.round(angle / snap) * snap;
                    currentMX = centerX + dist * Math.cos(angle);
                    currentMY = centerY + dist * Math.sin(angle);
                }
                draggingArrow.endX = currentMX;
                draggingArrow.endY = currentMY;
                draw();
                return;
            }

            const hoveredArrow = getArrowUnderMouse(mx, my);
            if (hoveredArrow) {
                tooltip.style.display = 'block';
                const finalX = hoveredArrow.offsetEndX !== undefined ? hoveredArrow.offsetEndX : hoveredArrow.endX;
                const finalY = hoveredArrow.offsetEndY !== undefined ? hoveredArrow.offsetEndY : hoveredArrow.endY;
                tooltip.style.left = (finalX + 20) + 'px';
                tooltip.style.top = (finalY + 20) + 'px';

                const len = getLength(hoveredArrow.endX, hoveredArrow.endY);
                const ang = getPhysicsAngle(hoveredArrow.endX, hoveredArrow.endY);
                tooltip.innerHTML = `Length: ${len}px<br>&Theta;: ${ang}&deg;`;
            } else {
                tooltip.style.display = 'none';
            }

            const overCenter = dist(mx, my, centerX, centerY) < centerRadius + 5;
            canvas.style.cursor = (hoveredArrow || overCenter) ? 'pointer' : 'crosshair';
        });

        window.addEventListener('mouseup', () => {
            if (draggingArrow) {
                if (isCreatingNew) {
                    if (getLength(draggingArrow.endX, draggingArrow.endY) < 10) {
                        deleteArrow(draggingArrow);
                    } else {
                        createLabelInput(draggingArrow);
                    }
                } else {
                    draw();
                }
                draggingArrow = null;
                isCreatingNew = false;
                draw();
            }
        });

        // Touch support
        function touchHandler(event) {
            if (event.target !== canvas) return;
            var touches = event.changedTouches, first = touches[0], type = "";
            switch(event.type) {
                case "touchstart": type = "mousedown"; break;
                case "touchmove":  type = "mousemove"; break;
                case "touchend":   type = "mouseup";   break;
                default: return;
            }
            var simulatedEvent = new MouseEvent(type, {
                bubbles: true, cancelable: true, view: window,
                screenX: first.screenX, screenY: first.screenY,
                clientX: first.clientX, clientY: first.clientY,
                button: 0, ctrlKey: false, shiftKey: false
            });
            first.target.dispatchEvent(simulatedEvent);
            if(event.type === 'touchmove') event.preventDefault();
        }
        canvas.addEventListener("touchstart", touchHandler, {passive: false});
        canvas.addEventListener("touchmove", touchHandler, {passive: false});
        canvas.addEventListener("touchend", touchHandler, {passive: false});

        const helpBtn = document.getElementById('help-btn');
        const helpModal = document.getElementById('help-modal');
        helpBtn.addEventListener('click', () => helpModal.style.display = 'flex');
        document.querySelector('.modal-close').addEventListener('click', () => helpModal.style.display = 'none');
        helpModal.addEventListener('click', (e) => { if (e.target === helpModal) helpModal.style.display = 'none'; });

        setTimeout(resize, 100);
    </script>
</body>
</html>
